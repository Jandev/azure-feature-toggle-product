name: Deploy to Azure

on:
  # Trigger after CI workflow completes on main
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  # Manual trigger for plan/destroy or staging deployments
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy        # Apply Terraform + deploy app
          - plan          # Terraform plan only (no changes)
          - destroy       # Tear down infrastructure

env:
  TF_VERSION: '1.7'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  # Run Terraform to provision/update infrastructure
  terraform:
    name: Terraform ${{ inputs.action == 'plan' && 'Plan' || inputs.action == 'destroy' && 'Destroy' || 'Apply' }}
    runs-on: ubuntu-latest
    # Only run if: manual trigger OR CI workflow succeeded
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    environment: ${{ inputs.environment || 'production' }}
    outputs:
      resource_group: ${{ steps.tf-output.outputs.resource_group }}
      container_app_name: ${{ steps.tf-output.outputs.container_app_name }}
      client_id: ${{ steps.tf-output.outputs.client_id }}
      tenant_id: ${{ steps.tf-output.outputs.tenant_id }}

    defaults:
      run:
        working-directory: terraform

    steps:
      - uses: actions/checkout@v4
        with:
          # Use the SHA from the workflow_run event, or current SHA for manual trigger
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false  # Needed for outputs

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ inputs.environment || 'production' }}.terraform.tfstate"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          terraform plan \
            -var="environment=${{ inputs.environment || 'production' }}" \
            -var="project_name=feature-toggle" \
            -var="location=${{ vars.AZURE_LOCATION || 'westeurope' }}" \
            -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -out=tfplan \
            -detailed-exitcode
          exitcode=$?
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
          # Exit code 0 = no changes, 2 = changes present (both are success)
          # Exit code 1 = error
          if [ $exitcode -eq 1 ]; then
            exit 1
          fi
          exit 0
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Apply
        if: (inputs.action || 'deploy') == 'deploy' && steps.plan.outputs.exitcode != '1'
        run: terraform apply -auto-approve tfplan
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        run: |
          terraform destroy \
            -var="environment=${{ inputs.environment || 'production' }}" \
            -var="project_name=feature-toggle" \
            -var="location=${{ vars.AZURE_LOCATION || 'westeurope' }}" \
            -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -auto-approve
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true

      - name: Get Terraform Outputs
        id: tf-output
        if: (inputs.action || 'deploy') == 'deploy'
        run: |
          echo "resource_group=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
          echo "container_app_name=$(terraform output -raw container_app_name)" >> $GITHUB_OUTPUT
          echo "client_id=$(terraform output -raw client_id)" >> $GITHUB_OUTPUT
          echo "tenant_id=$(terraform output -raw tenant_id)" >> $GITHUB_OUTPUT
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true

  # Deploy to Container Apps using the image built by CI
  deploy:
    name: Deploy to Container Apps
    runs-on: ubuntu-latest
    needs: terraform
    if: (inputs.action || 'deploy') == 'deploy'
    environment: ${{ inputs.environment || 'production' }}

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag image as latest
        env:
          IMAGE_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
        run: |
          # Pull the image built by CI using the commit SHA tag
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_SHA}
          # Tag it as latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_SHA} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          # Push the latest tag
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Container Apps
        run: |
          az containerapp update \
            --name ${{ needs.terraform.outputs.container_app_name }} \
            --resource-group ${{ needs.terraform.outputs.resource_group }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Get App URL
        id: app-url
        env:
          IMAGE_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
        run: |
          URL=$(az containerapp show \
            --name ${{ needs.terraform.outputs.container_app_name }} \
            --resource-group ${{ needs.terraform.outputs.resource_group }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          echo "url=https://$URL" >> $GITHUB_OUTPUT
          echo "### Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** https://$URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_SHA}\` (tagged as \`latest\`)" >> $GITHUB_STEP_SUMMARY
